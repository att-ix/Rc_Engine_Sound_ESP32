<!DOCTYPE html>
<meta charset="utf-8">

<head>
<script src="./samples.js" type="text/javascript"></script>
<script src="./base64.js" type="text/javascript"></script>
<script src="./VehicleSimulation.js" type="text/javascript"></script>
<script src="./d3js.org_d3.v4.js" type="text/javascript"></script>
<script>

/** We create the user inputs via a dict, since
    there are so many of them.
 */

// import {VehicleSimulation} from './VehicleSimulation.js';
var vehicleSimulation = new VehicleSimulation();

// -- the following lists are displayed as values in the graph:
// list: [attribute name from VehicleSimulation, color name, scale factor, data, dash pattern]
const displayValues = [
  ['currentThrottleFaded', 'Navy', 0.2, [], "1,0"],
  ['selectedGear', 'Blue', 12.0, [], "10,5"],
  ['selectedAutomaticGear', 'CadetBlue', 13.0, [], "10,5"],
  ['clutchDisengaged', 'DarkSlateBlue', 100.0, [], "1,0"],
  ['overdrive', 'Chocolate', 99.0, [], "1,0"],
  ['engineOn', 'Crimson', 98.0, [], "1,0"],
  ['engineRunning', 'MediumPurple', 97.0, [], "1,0"],
  ['driveState', 'Olive', 11.0, [], "1,0"],
  ['engineState', 'OliveDrab', 10.0, [], "1,0"],
  ['engineLoad', 'DarkSalmon', 0.2, [], "1,0"],
  ['targetRpm', 'DarkGrey', 0.2, [], "5,10"],
  ['currentRpm', 'DarkSlateGrey', 0.2, [], "5,5"],
  ['currentSpeed', 'DeepPink', 0.2, [], "1,0"],
  ['escPulseWidth', 'HotPink', 0.05, [], "1,0"]
];

// -- the following lists are created as input elements:

// values from vehicles.h
const vehicleValues = [
  ['TRACKED_MODE', false, 0, 0],
  ['AIRPLANE_MODE', false, 0, 0],
  ['EXCAVATOR_MODE', false, 0, 0],
  ['STEAM_LOCOMOTIVE_MODE', false, 0, 0],
  ['SUPER_SLOW', false, 0, 0],

  ['NumberOfAutomaticGears', 6, 3, 6],

  ['startVolumePercentage', 120, 0, 200],
  ['idleVolumePercentage', 72, 0, 200],
  ['engineIdleVolumePercentage', 60, 0, 200],
  ['fullThrottleVolumePercentage', 130, 0, 200],
  ['revVolumePercentage', 80, 0, 200],
  ['engineRevVolumePercentage', 60, 0, 200],

  ['REV_SOUND', true, 0, 0],
  ['revSwitchPoint', 10, 0, 200],
  ['idleEndPoint', 500, 0, 1000],
  ['idleVolumeProportionPercentage', 90, 0, 200],

  ['JAKEBRAKE_ENGINE_SLOWDOWN', true, 0, 0],
  ['JAKE_BRAKE_SOUND', true, 0, 0],
  ['dieselKnockVolumePercentage', 40, 0, 200],
  ['dieselKnockIdleVolumePercentage', 0, 0, 200],
  ['dieselKnockStartPoint', 10, 0, 1000],
  ['dieselKnockInterval', 8, 0, 20],

  ['V8', true, 0, 0],
  ['dieselKnockAdaptiveVolumePercentage', 18, 0, 200],

  ['RPM_DEPENDENT_KNOCK', true, 0, 200],
  ['minKnockVolumePercentage', 80, 0, 200],
  ['knockStartRpm', 50, 0, 200],

  ['turboVolumePercentage', 5, 0, 200],
  ['turboIdleVolumePercentage', 0, 0, 200],
  ['chargerVolumePercentage', 0, 0, 200],
  ['chargerIdleVolumePercentage', 10, 0, 200],
  ['chargerStartPoint', 10, 0, 200],

  ['wastegateVolumePercentage', 18, 0, 200],
  ['wastegateIdleVolumePercentage', 1, 0, 200],

  ['fanVolumePercentage', 0, 0, 200],
  ['fanIdleVolumePercentage', 0, 0, 200],
  ['fanStartPoint', 0, 0, 200],

  ['hornVolumePercentage', 80, 0, 200],
  ['sirenVolumePercentage', 80, 0, 200],

  ['brakeVolumePercentage', 30, 0, 200],
  ['parkingBrakeVolumePercentage', 30, 0, 200],
  ['shiftingVolumePercentage', 40, 0, 200],
  ['sound1VolumePercentage', 100, 0, 200],

  ['reversingVolumePercentage', 14, 0, 200],

  ['indicatorVolumePercentage', 10, 0, 200],

  ['escRampTimeFirstGear', 20, 0, 200],
  ['escRampTimeSecondGear', 50, 0, 200],
  ['escRampTimeThirdGear', 75, 0, 200],
  ['escBrakeSteps', 30, 0, 200],
  ['escAccelerationSteps', 3, 0, 200],

  ['automatic', false, 0, 0],
  ['doubleClutch', false, 0, 0],
  ['shiftingAutoThrottle', true, 0, 0],
  ['clutchEngagingPoint', 90, 0, 200],

  ['MAX_RPM_PERCENTAGE', 330, 0, 1000],

  ['acc', 2, 1, 20],
  ['dec', 1, 1, 20],
];

// -- defines in 2_remotes.h
const remoteValues = [
  ['AUTO_ENGINE_ON_OFF', true, 0, 200],
  ['AUTO_LIGHTS', true, 0, 200],
];

// -- defines in 4_transmission.h
const transmissionValues = [
  ['OVERDRIVE', false, 0, 0],
  ['VIRTUAL_3_SPEED', false, 0, 0],
  // ['VIRTUAL_16_SPEED_SEQUENTIAL', false, 0, 0], documentation says: don't use
  ['automaticReverseAccelerationPercentage', 100, 0, 200],
  ['lowRangePercentage', 58, 0, 200],
  ['SEMI_AUTOMATIC', false, 0, 0],
  ['TRANSMISSION_NEUTRAL', true, 0, 0],
  ['maxClutchSlippingRpm', 250, 0, 400],
  ['DOUBLE_CLUTCH', false, 0, 0],
  ['HIGH_SLIPPINGPOINT', false, 0, 0]
];


const valueOnchangeFunction = function() {
  // I get the name of the attribute from the input ID.
  // e.g. input_AUTO_LIGHTS
  const name = this.id.slice("input_".length);
  if ((typeof vehicleSimulation[name]) == "boolean") {
    vehicleSimulation[name] = this.checked;
  } else {
    vehicleSimulation[name] = Number(this.value);
  }
}

/** Adds an input element plus label plus table row to the parent element.
 *
 *  @param defs An array of "name", default value, minimum, maximum value
 */
function addInputTr(defs, parentElement) {

  let elTr = document.createElement('tr');

  const id = "input_" + defs[0];
  let elLabel = document.createElement('label');
  elLabel.setAttribute("for", id);
  elLabel.textContent = defs[0] + ":";
  let elTd = document.createElement('td');
  elTd.appendChild(elLabel);
  elTr.appendChild(elTd);

  let elInput = document.createElement('input');
  elInput.id = id;
  if ((typeof defs[1]) == "boolean") {
    elInput.type = 'checkbox';
    elInput.checked = defs[1];
  } else if ((typeof defs[1]) == "number") {
    elInput.type = 'number';
    elInput.min = defs[2];
    elInput.max = defs[3];
    elInput.value = defs[1];
  }
  elInput.onchange = valueOnchangeFunction;
  elTd = document.createElement('td');
  elTd.appendChild(elInput);
  elTr.appendChild(elTd);


  parentElement.appendChild(elTr);
}


/** Adds all input elements from the defs array
 *
 *  @param defs An array of an array with the values used by addInput()
 */
function addInputs(defss, parentElement) {
  for (let i = 0; i < defss.length; i++) {
    addInputTr(defss[i], parentElement);
  }
}


function updateMassSimulation()
{
  vehicleSimulation.step(1); // has to be in sync with timer interval
}

function addGraph(parentElement)
{
  // set the dimensions and margins of the graph
  const margin = {top: 10, right: 30, bottom: 30, left: 60};
  const width = d3.select(parentElement).node().getBoundingClientRect().width
    - margin.left - margin.right
  // const width = 460 - margin.left - margin.right;
  const height = 400 - margin.top - margin.bottom;

  // append the svg object to the body of the page
  var svg = d3.select(parentElement)
    .append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
    .append("g")
      .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");
  svg.id = "graph";

  let x = d3.scaleLinear()
    .domain([0, 100])
    .range([-5, width]); // starting point is -5 so the first value doesn't show and slides off the edge as part of the transition
  svg.append("g")
    .attr("transform", "translate(0," + height + ")")
    .call(d3.axisBottom(x));

  var y = d3.scaleLinear()
    .domain([100, 0])
    .range([0, height]);
  svg.append("g")
    .call(d3.axisLeft(y));

  let line = d3.line()
    .x(function(d, i) { return x(i) })
    .y(function(d) { return y(d) });

  // -- add the line graphs
  // actually we don't need a loop here. do it d3 style
  for (let i = 0; i < displayValues.length; i++) {
    let values = displayValues[i];
    svg
      .append("path")
      .attr("id", "graph" + values[0])
      .datum(values[3])
      .attr("fill", "none")
      .attr("stroke", values[1])
      .attr("stroke-width", 1.5)
      .attr("stroke-dasharray", values[4])
      .attr("d", line);
  }

  // -- add a legend
  const size = 10;
  svg.selectAll("legendDots")
    .data(displayValues)
    .enter()
    .append("line") //making a line for legend
      .attr("x1", 50 - size * 2)
      .attr("x2", 50)
      .attr("y1", function(d,i){ return 20 + i*(size+5)}) // 100 is where the first dot appears. 25 is the distance between dots
      .attr("y2", function(d,i){ return 20 + i*(size+5)}) // 100 is where the first dot appears. 25 is the distance between dots
      .style("stroke-dasharray", function(d){return d[4]})
      .style("stroke", function(d){ return d[1]});

                                  /*
  svg.selectAll("legendDots")
    .data(displayValues)
    .enter()
    .append("rect")
      .attr("x", 50)
      .attr("y", function(d,i){ return 20 + i*(size+5)}) // 100 is where the first dot appears. 25 is the distance between dots
      .attr("width", size)
      .attr("height", size)
      .style("fill", function(d){ return d[1]})
                                  */

  svg.selectAll("legendLabels")
    .data(displayValues)
    .enter()
    .append("text")
      .attr("x", 50 + size*2.2)
      .attr("y", function(d,i){ return 20 + i*(size+5) + (size/2)}) // 100 is where the first dot appears. 25 is the distance between dots
      .style("fill", function(d){ return d[1]})
      .text(function(d){ return d[0]})
      .attr("text-anchor", "left")
      .style("alignment-baseline", "middle")

  function redraw() {
    for (let i = 0; i < displayValues.length; i++) {
      let values = displayValues[i];
      let data = values[3];
      if (data.length > 100) {
        data.shift();
      }
      data.push(vehicleSimulation[values[0]] * values[2]);
      svg.select("#graph" + values[0])
        .data([data]) // set the new data
        .attr("d", line); // apply the new data values
    }
  }

  setInterval(function() {
     redraw();
  }, 100);
}


// see
// https://stackoverflow.com/questions/67342004/how-to-continuously-generate-raw-audio-samples-in-javascript-using-the-web-audio

const blob = new Blob(
  [`
    class MyProcessor extends AudioWorkletProcessor {
      process(_, outputs) {
        for (const output of outputs) {
          for (const channelData of output) {
            for (let i = 0; i < channelData.length; i += 1) {
                channelData[i] = Math.random() * 2 - 1;
            }
          }
        }
        return true;
      }
    }
    registerProcessor('my-processor', MyProcessor);
  `],
  { type: 'application/javascript' }
);

</script>

<style>
	body {
    font-family: arial;
	}
  legend {
    background-color: #000;
    color: #fff;
    padding: 3px 6px;
  }
  fieldset {
    width: fit-content;
	  background-color: #eee;
  }
  fieldset label {
    width: 20em;
  }
  tr:nth-child(even) {background-color: #ddd;}
  td { vertical-align: top; }

  #graphDiv {
    width: 1000px;
  }
</style>

</head>

<body>
  <h3>RC Engine Sound simulation</h3>
  <table>
    <tr>
      <td rowspan="2">
        <fieldset>
          <legend>Values from vehicle.h</legend>
          <table id="inputTableVehicle">
          </table>
        </fieldset>
      </td>
      <td rowspan="1">
        <fieldset>
          <legend>Values from transmission.h</legend>
          <table id="inputTableTransmission">
          </table>
        </fieldset>
      </td>
      <td style="height: 1px;">
        <fieldset>
          <legend>Controls</legend>
        <table>
          <tr>
            <td>
              <label for="inputThrottle">throttle:</label>
            </td>
            <td>
              <input type="range" id="inputThrottle" min="1000" max="2000" value="1500"
                 onchange="vehicleSimulation.pulseWidth = this.value; vehicleSimulation.updateAudio();"/>
            </td>
          </tr>
          <tr>
            <td>
              <label for="inputGear">gear:</label>
            </td>
            <td>
              <input type="range" id="inputGear" min="1" max="6" value="1"
                 onchange="vehicleSimulation.selectedGear = this.value"/>
            </td>
          </tr>
          <tr>
            <td>
              <label>Sounds:</label>
            </td>
            <td>
              <input type="button" id="inputSiren"
                 onclick="vehicleSimulation.sirenTrigger = true"
                 value="Siren"/>
              <input type="button" id="inputHorn"
                 onclick="vehicleSimulation.hornTrigger = true"
                 value="Horn"/>
              <input type="button" id="inputIndicator"
                 onclick="vehicleSimulation.indicatorSoundOn = true"
                 value="Indicator"/>
            </td>
          </tr>
          <tr>
            <td>
              <label for="inputIndicator">Master volume:</label>
            </td>
            <td>
              <input type="range" id="inputVolume" min="0" max="100" value="100"
                 onchange="vehicleSimulation.masterVolume = this.value"/>
            </td>
          </tr>
        </table>
        </fieldset>
      </td>
    </tr>
    <tr>
      <td colspan="2">
        <div id="graphDiv"></div>
      </td>
    </tr>
  </table>
  <small>
    Ralf Engels for <a href="https://github.com/TheDIYGuy999/Rc_Engine_Sound_ESP32">ESP32 RC Engine Sound & Light Controller</a>
  </small>

  <script type="module">
    addInputs(vehicleValues,
       document.querySelector('#inputTableVehicle'));
    addInputs(transmissionValues,
       document.querySelector('#inputTableTransmission'));
    addGraph(
       document.querySelector('#graphDiv'));
    const massSimulationInterval = setInterval(updateMassSimulation, 1);
  </script>
</body>

</html>
